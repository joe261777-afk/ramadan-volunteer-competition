<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ÙØ±Ù‚ Ø§Ù„ØªØ·ÙˆØ¹ÙŠØ© - Ø±Ù…Ø¶Ø§Ù†</title>
  <style>
  :root {
    --ramadan-night: #050816;
    --ramadan-deep: #060b1c;
    --ramadan-green: #0f766e;
    --ramadan-green-soft: #14b8a6;
    --ramadan-gold: #facc6b;
    --ramadan-gold-soft: #fcdca4;
    --card-bg: rgba(10, 15, 35, 0.82);
    --border-soft: rgba(252, 211, 77, 0.35);
    --text-main: #f9fafb;
    --text-muted: #9ca3af;
  }

  * { box-sizing: border-box; }

  body {
    font-family: "Tahoma", system-ui, -apple-system, BlinkMacSystemFont;
    background:
      radial-gradient(circle at 10% 20%, rgba(76, 106, 191, 0.18) 0, transparent 50%),
      radial-gradient(circle at 80% 0%, rgba(244, 196, 48, 0.12) 0, transparent 55%),
      linear-gradient(to bottom, var(--ramadan-night), var(--ramadan-deep));
    margin: 0;
    padding: 0;
    color: var(--text-main);
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
  }

  body::before {
    content: "";
    position: fixed;
    inset: 0;
    background-image:
      radial-gradient(circle, rgba(255, 255, 255, 0.8) 1px, transparent 1px),
      radial-gradient(circle, rgba(255, 255, 255, 0.35) 1px, transparent 1px);
    background-size: 120px 120px, 200px 200px;
    background-position: 0 0, 60px 80px;
    opacity: 0.25;
    pointer-events: none;
    z-index: -1;
  }

  header {
    background: radial-gradient(circle at top left, rgba(250, 204, 21, 0.35), transparent 55%),
                linear-gradient(120deg, #020617, #020617);
    color: var(--text-main);
    padding: 18px 0;
    border-bottom: 1px solid rgba(148, 163, 184, 0.35);
    box-shadow:
      0 18px 45px rgba(15, 23, 42, 0.95),
      0 0 0 1px rgba(30, 64, 175, 0.45);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .header-content {
    max-width: 950px;
    margin: 0 auto;
    padding: 0 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }

  .header-right h1 {
    margin: 0 0 4px 0;
    font-size: 1.6rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .header-right p {
    margin: 0;
    color: var(--text-muted);
    font-size: 0.9rem;
  }

  .header-left {
    display: flex;
    align-items: flex-end;
    gap: 10px;
  }

  .lantern {
    width: 22px;
    height: 48px;
    border-radius: 999px;
    border: 2px solid var(--ramadan-gold);
    box-shadow:
      0 0 12px rgba(250, 204, 21, 0.7),
      0 0 40px rgba(250, 204, 21, 0.45);
    position: relative;
    background: radial-gradient(circle at 50% 20%, #fef3c7, #fbbf24, #92400e);
  }

  .lantern::before {
    content: "";
    position: absolute;
    top: -12px;
    left: 50%;
    width: 14px;
    height: 10px;
    transform: translateX(-50%);
    border-radius: 999px;
    border: 2px solid var(--ramadan-gold);
    background: rgba(15, 23, 42, 0.9);
  }

  .lantern::after {
    content: "";
    position: absolute;
    top: -22px;
    left: 50%;
    width: 2px;
    height: 12px;
    transform: translateX(-50%);
    background: linear-gradient(to top, var(--ramadan-gold), transparent);
  }

  .lantern-1 { transform: translateY(4px); }
  .lantern-2 { transform: translateY(-3px) scale(0.9); opacity: 0.85; }

  .container {
    max-width: 950px;
    margin: 24px auto 40px auto;
    background: radial-gradient(circle at top left, rgba(8, 47, 73, 0.7), transparent 55%),
                radial-gradient(circle at bottom right, rgba(22, 101, 52, 0.6), transparent 55%),
                var(--card-bg);
    padding: 22px 18px 24px 18px;
    border-radius: 18px;
    box-shadow:
      0 24px 60px rgba(0, 0, 0, 0.75),
      0 0 0 1px rgba(148, 163, 184, 0.35);
    border: 1px solid var(--border-soft);
    backdrop-filter: blur(16px);
  }

  h2 {
    margin-top: 18px;
    margin-bottom: 8px;
    color: var(--ramadan-gold);
    border-bottom: 1px dashed rgba(148, 163, 184, 0.4);
    padding-bottom: 4px;
    font-size: 1.1rem;
  }

  h3 {
    color: var(--ramadan-green-soft);
    margin-top: 18px;
    margin-bottom: 6px;
    font-size: 1rem;
  }

  .field-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin: 8px 0;
    flex-wrap: wrap;
  }

  .field-row label {
    flex: 1;
    font-size: 0.9rem;
    color: var(--text-main);
  }

  .field-row input[type="number"],
  .field-row input[type="date"],
  .field-row input[type="text"],
  .field-row input[type="password"],
  .field-row input[type="file"] {
    width: 230px;
    padding: 7px 8px;
    border-radius: 10px;
    border: 1px solid rgba(148, 163, 184, 0.7);
    background: rgba(15, 23, 42, 0.95);
    color: var(--text-main);
    font-size: 0.85rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s, background 0.2s, transform 0.1s;
  }

  .field-row input[type="file"] { padding: 5px 6px; }

  .field-row input::placeholder { color: rgba(148, 163, 184, 0.8); }

  .field-row input:focus {
    border-color: var(--ramadan-green-soft);
    box-shadow:
      0 0 0 1px rgba(45, 212, 191, 0.5),
      0 0 20px rgba(45, 212, 191, 0.2);
    background: rgba(15, 23, 42, 0.98);
    transform: translateY(-1px);
  }

  .hint {
    font-size: 0.78rem;
    color: var(--text-muted);
    line-height: 1.7;
    margin: 4px 0 8px 0;
  }

  button {
    margin-top: 10px;
    padding: 9px 18px;
    border: none;
    border-radius: 999px;
    background: linear-gradient(135deg, var(--ramadan-green), var(--ramadan-green-soft));
    color: #ecfeff;
    font-size: 0.9rem;
    cursor: pointer;
    font-weight: 600;
    letter-spacing: 0.02em;
    box-shadow:
      0 12px 30px rgba(15, 118, 110, 0.6),
      0 0 0 1px rgba(34, 197, 186, 0.4);
    transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, filter 0.12s;
  }

  button:hover {
    transform: translateY(-1px) scale(1.01);
    box-shadow:
      0 16px 40px rgba(15, 118, 110, 0.8),
      0 0 0 1px rgba(34, 197, 186, 0.6);
    filter: brightness(1.03);
  }

  button:active {
    transform: translateY(1px) scale(0.99);
    box-shadow:
      0 8px 20px rgba(15, 23, 42, 0.9),
      0 0 0 1px rgba(34, 197, 186, 0.7);
  }

  .result {
    margin-top: 15px;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--ramadan-gold-soft);
    line-height: 1.7;
    background: radial-gradient(circle at top left, rgba(22, 101, 52, 0.4), transparent 55%),
                rgba(15, 23, 42, 0.9);
    border-radius: 12px;
    padding: 10px 12px;
    border: 1px solid rgba(74, 222, 128, 0.3);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: rgba(15, 23, 42, 0.92);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.9);
  }

  th, td {
    border: 1px solid rgba(30, 64, 175, 0.35);
    padding: 6px;
    text-align: center;
    font-size: 0.8rem;
    color: #e5e7eb;
  }

  th {
    background: linear-gradient(135deg, rgba(15, 118, 110, 0.95), rgba(30, 64, 175, 0.9));
    color: #fefce8;
    font-weight: 600;
  }

  tbody tr:nth-child(even) { background: rgba(15, 23, 42, 0.96); }
  tbody tr:nth-child(odd)  { background: rgba(15, 23, 42, 0.86); }
  tbody tr:hover { background: rgba(22, 163, 74, 0.35); }

  .login-card {
    max-width: 420px;
    margin: 40px auto;
    background:
      radial-gradient(circle at top left, rgba(56, 189, 248, 0.45), transparent 60%),
      radial-gradient(circle at bottom right, rgba(22, 163, 74, 0.55), transparent 60%),
      rgba(15, 23, 42, 0.95);
    padding: 22px 18px 20px 18px;
    border-radius: 18px;
    box-shadow:
      0 24px 60px rgba(0, 0, 0, 0.9),
      0 0 0 1px rgba(148, 163, 184, 0.6);
    border: 1px solid var(--border-soft);
    backdrop-filter: blur(18px);
    color: var(--text-main);
  }

  .login-card h2 { border-bottom: none; margin-top: 0; text-align: center; }

  .role-info {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 10px;
    line-height: 1.7;
  }

  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 0.75rem;
    background: linear-gradient(135deg, var(--ramadan-gold), #f97316);
    color: #1f2937;
    margin-right: 5px;
    box-shadow: 0 4px 12px rgba(248, 250, 252, 0.3);
  }

  #adminPhotosContainer img {
    max-width: 140px;
    max-height: 140px;
    margin: 4px;
    border-radius: 10px;
    border: 1px solid rgba(250, 204, 21, 0.6);
    box-shadow:
      0 10px 25px rgba(15, 23, 42, 0.9),
      0 0 15px rgba(250, 204, 21, 0.5);
    object-fit: cover;
  }

  .hidden { display: none; }

  .target-progress-wrapper { width: 100%; margin-top: 4px; margin-bottom: 6px; }
  .target-progress-label { font-size: 0.78rem; color: var(--text-muted); margin-bottom: 2px; }
  .target-progress-bar {
    width: 100%;
    height: 9px;
    border-radius: 999px;
    overflow: hidden;
    background: rgba(15, 23, 42, 0.95);
    border: 1px solid rgba(148, 163, 184, 0.6);
  }
  .target-progress-fill {
    height: 100%;
    border-radius: inherit;
    background: linear-gradient(90deg, #22c55e, #a3e635, #facc15);
    width: 0%;
    transition: width 0.25s ease-out;
  }

  .score-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.82);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 40;
  }
  .score-overlay.hidden { display: none; }

  .score-overlay-content {
    width: min(420px, 90%);
    background:
      radial-gradient(circle at top left, rgba(250, 204, 21, 0.25), transparent 55%),
      radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.25), transparent 55%),
      rgba(15, 23, 42, 0.98);
    border-radius: 20px;
    padding: 18px 16px 20px 16px;
    border: 1px solid rgba(252, 211, 77, 0.7);
    box-shadow:
      0 24px 60px rgba(0, 0, 0, 0.9),
      0 0 35px rgba(250, 204, 21, 0.7);
    text-align: center;
  }

  .score-overlay-content h2 { border-bottom: none; margin: 0 0 8px 0; color: var(--ramadan-gold-soft); }
  .score-main { font-size: 1.4rem; font-weight: 700; margin: 4px 0 8px 0; }

  .overlay-bar-wrapper {
    width: 100%;
    height: 12px;
    border-radius: 999px;
    overflow: hidden;
    background: rgba(15, 23, 42, 0.95);
    border: 1px solid rgba(148, 163, 184, 0.8);
    margin-bottom: 6px;
  }
  .overlay-bar-fill {
    height: 100%;
    border-radius: inherit;
    background: linear-gradient(90deg, #22c55e, #a3e635, #facc15);
    width: 0;
  }

  .score-rank { font-size: 0.95rem; margin: 6px 0; }
  .score-trend { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px; }
  .score-overlay-content button { margin-top: 6px; }

  .score-overlay-content.rank-up {
    animation: rankUpGlow 0.9s ease-out;
    box-shadow:
      0 0 25px rgba(250, 204, 21, 0.9),
      0 0 60px rgba(250, 204, 21, 0.8),
      0 0 0 2px rgba(250, 204, 21, 0.8);
  }

  .score-overlay-content.rank-down {
    animation: rankDownShake 0.7s ease-out;
    box-shadow:
      0 0 25px rgba(239, 68, 68, 0.9),
      0 0 60px rgba(239, 68, 68, 0.6),
      0 0 0 2px rgba(239, 68, 68, 0.8);
  }

  .rank-down-rocket { font-size: 2rem; margin-bottom: 4px; animation: rocketDown 0.8s ease-in forwards; }

  @keyframes rankUpGlow {
    0% {
      transform: scale(0.92);
      box-shadow:
        0 0 5px rgba(250, 204, 21, 0.4),
        0 0 10px rgba(250, 204, 21, 0.3);
    }
    40% { transform: scale(1.03); }
    100% { transform: scale(1); }
  }

  @keyframes rankDownShake {
    0%   { transform: translateX(0); }
    20%  { transform: translateX(-5px); }
    40%  { transform: translateX(5px); }
    60%  { transform: translateX(-4px); }
    80%  { transform: translateX(4px); }
    100% { transform: translateX(0); }
  }

  @keyframes rocketDown {
    0% { transform: translateY(-30px); opacity: 0; }
    40% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(40px); opacity: 0; }
  }

  @media (max-width: 768px) {
    .header-content { flex-direction: column; align-items: flex-start; }
    .header-left { align-self: flex-end; margin-top: 6px; }
    .container { margin: 18px 10px 28px 10px; padding: 18px 12px 20px 12px; }
    .field-row input[type="number"],
    .field-row input[type="date"],
    .field-row input[type="text"],
    .field-row input[type="password"],
    .field-row input[type="file"] { width: 100%; }
    header { padding: 14px 0; }
  }
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="header-right">
      <h1>ğŸŒ™ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ÙØ±Ù‚ Ø§Ù„ØªØ·ÙˆØ¹ÙŠØ© ÙÙŠ Ø±Ù…Ø¶Ø§Ù†</h1>
      <p>Ù„ÙˆØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙØ±Ù‚</p>
    </div>
    <div class="header-left">
      <div class="lantern lantern-1"></div>
      <div class="lantern lantern-2"></div>
    </div>
  </div>
</header>

<!-- Login -->
<div id="loginSection" class="login-card">
  <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>

  <div class="field-row">
    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
    <input type="text" id="loginName" placeholder="Ù…Ø«Ø§Ù„: admin Ø£Ùˆ ÙØ±ÙŠÙ‚ Ø§Ù„Ø±Ø­Ù…Ø©" />
  </div>

  <div class="field-row">
    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
    <input type="password" id="loginPassword" placeholder="Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·" />
  </div>

  <button onclick="handleLogin()">Ø¯Ø®ÙˆÙ„</button>
  <button type="button" onclick="openLeaderboard()" style="margin-top:8px;background:linear-gradient(135deg,#facc6b,#f59e0b);color:#1f2937;">
  ğŸ† Ù…Ø´Ø§Ù‡Ø¯Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù
</button>


  <div class="role-info">
    <span class="badge">Admin</span>
    Ù„Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ£Ø¯Ù…Ù†:<br>
    Username: <strong>admin</strong><br>
    Password: <strong>admin123</strong><br><br>
    Ø£ÙŠ Ø§Ø³Ù… Ø¢Ø®Ø± âœ ÙŠÙØ¹ØªØ¨Ø± <strong>Ù‚Ø§Ø¦Ø¯ ÙØ±ÙŠÙ‚</strong> ÙˆÙŠØªÙ… ÙØªØ­ ØµÙØ­Ø© Ø¥Ø¯Ø®Ø§Ù„ Ù†Ù‚Ø§Ø· Ù„ÙØ±ÙŠÙ‚Ù‡.
  </div>
</div>

<!-- User Page -->
<div id="userSection" class="container hidden">

  <h2>ØµÙØ­Ø© Ù‚Ø§Ø¦Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚</h2>
  <p class="hint" id="userWelcome"></p>

  <div class="field-row">
    <label>Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚:</label>
    <input type="text" id="teamName" disabled />
  </div>

  <div class="field-row">
    <label>Ø¹Ø¯Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚ (Ø§Ù„ÙƒØ§Ù…Ù„):</label>
    <input type="number" id="teamSize" min="1" placeholder="Ù…Ø«Ø§Ù„: 15" />
  </div>

  <div class="field-row">
    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…:</label>
    <input type="date" id="dayDate" />
  </div>

  <!-- Ø§Ù„ØªØ¹Ø¨Ø¦Ø© -->
  <h3>Ø§Ù„ØªØ¹Ø¨Ø¦Ø© (Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ²Ù† Ø§Ù„Ù‚Ø³Ù… = Ù¤Ù Ùª)</h3>

  <div class="field-row">
    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù†Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø§Ù„ÙŠÙˆÙ… (ØªØ§Ø±Ø¬Øª Ø§Ù„ÙŠÙˆÙ…):</label>
    <input type="number" id="bags_target" min="0" placeholder="Ù…Ø«Ø§Ù„: 100" />
  </div>

  <div class="field-row">
    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù†Ø· Ø§Ù„Ù„ÙŠ Ø§ØªØ¹Ù…Ù„Øª ÙØ¹Ù„Ø§Ù‹ Ø§Ù„ÙŠÙˆÙ…:</label>
    <input type="number" id="bags_done" min="0" placeholder="Ù…Ø«Ø§Ù„: 80" />
  </div>

  <p class="hint">
    Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø´Ù†Ø· = (Ø§Ù„Ù…Ù†ÙØ° Ã· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨) Ã— Ù¢Ù Ùª.
  </p>

  <div class="field-row">
    <label>ØµÙˆØ± Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ¹Ø¨Ø¦Ø© ÙˆØ§Ù„Ù†Ø¸Ø§Ù… (ÙŠØªÙ… ØªÙ‚ÙŠÙŠÙ…Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø£Ø¯Ù…Ù†):</label>
    <input type="file" id="fill_quality_photos" accept="image/*" multiple />
  </div>

  <div class="field-row">
    <label>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ (0 â†’ 25):</label>
    <input type="number" id="fill_time" min="0" max="25" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ÙŠÙˆÙ…" />
  </div>

  <!-- Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª -->
  <h3>Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª (ØªØ±Ø§ÙƒÙ…ÙŠ â€“ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ²Ù† Ø§Ù„Ù‚Ø³Ù… = Ù¢Ù¥Ùª)</h3>

  <div class="field-row">
    <label>Ø§Ù„Ù…Ø¬Ø²ÙØ± â€“ Ù…Ø¨Ù„Øº Ø§Ù„ÙŠÙˆÙ… (ØªØ§Ø±Ø¬Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© 15000):</label>
    <input type="number" id="donation_meat" min="0" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡" />
  </div>
  <div class="target-progress-wrapper">
    <div class="target-progress-label">
      ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø¬Ø²Ø±: <span id="meatProgressText">0 / 15000 (0Ùª)</span>
    </div>
    <div class="target-progress-bar">
      <div id="meatProgressFill" class="target-progress-fill"></div>
    </div>
  </div>

  <div class="field-row">
    <label>Ø£ØµØ­Ø§Ø¨ Ø§Ù„Ø¨ÙŠØª â€“ Ù…Ø¨Ù„Øº Ø§Ù„ÙŠÙˆÙ… (ØªØ§Ø±Ø¬Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© 5000):</label>
    <input type="number" id="donation_house" min="0" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡" />
  </div>
  <div class="target-progress-wrapper">
    <div class="target-progress-label">
      ØªÙ‚Ø¯Ù… Ø£ØµØ­Ø§Ø¨ Ø§Ù„Ø¨ÙŠØª: <span id="houseProgressText">0 / 5000 (0Ùª)</span>
    </div>
    <div class="target-progress-bar">
      <div id="houseProgressFill" class="target-progress-fill"></div>
    </div>
  </div>

  <div class="field-row">
    <label>ØªÙ†ÙˆØ¹ â€“ Ø¹Ø¯Ø¯ Ø£Ù†ÙˆØ§Ø¹/Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ¨Ø±Ø¹ Ø§Ù„ÙŠÙˆÙ…:</label>
    <input type="number" id="donation_variety" min="0" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ÙŠÙˆÙ…" />
  </div>

  <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
  <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (ØªØ±Ø§ÙƒÙ…ÙŠ â€“ ÙˆØ²Ù† Ø§Ù„Ø¨Ù†Ø¯ = Ù¥Ùª)</h3>

  <div class="field-row">
    <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ÙŠÙˆÙ… (ØªØ§Ø±Ø¬Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© 3000):</label>
    <input type="number" id="products_today" min="0" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡" />
  </div>
  <div class="target-progress-wrapper">
    <div class="target-progress-label">
      ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: <span id="productsProgressText">0 / 3000 (0Ùª)</span>
    </div>
    <div class="target-progress-bar">
      <div id="productsProgressFill" class="target-progress-fill"></div>
    </div>
  </div>

  <!-- Ø§Ù„ØªØ·ÙˆØ¹ -->
  <h3>Ø§Ù„ØªØ§Ø±Ø¬Øª Ø§Ù„ØªØ·ÙˆØ¹ÙŠ (Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ²Ù† Ø§Ù„Ù‚Ø³Ù… = Ù£Ù Ùª)</h3>

  <div class="field-row">
    <label>Ø­Ø¶ÙˆØ± Ø§Ù„ÙØ±ÙŠÙ‚ (Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ… Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚):</label>
    <input type="number" id="vol_team_presence" min="0" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…" />
  </div>

  <div class="field-row">
    <label>Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯ (0 â†’ 25):</label>
    <input type="number" id="vol_new_volunteers" min="0" max="25" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ÙŠÙˆÙ…" />
  </div>

  <div class="field-row">
    <label>Ø±Ø§Ø¨Ø· Ø´ÙŠØª Ø§Ù„Ø­Ø¶ÙˆØ± (Google Sheets / Drive):</label>
    <input type="text" id="vol_sheet_link" placeholder="Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ø´ÙŠØª Ù‡Ù†Ø§" />
  </div>

  <p class="hint">
    Ø´ÙŠØª Ø§Ù„Ø­Ø¶ÙˆØ± + Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ¹Ø¨Ø¦Ø© ÙŠØªÙ… ØªÙ‚ÙŠÙŠÙ…Ù‡Ù… ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†.
  </p>

  <button onclick="calculateDay()">Ø§Ø­Ø³Ø¨ Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠÙˆÙ…</button>

  <div class="result" id="resultText"></div>

  <!-- Ø²Ø± Ùˆ Section Ù…Ù„Ø®Øµ Ø§Ù„Ø£ÙŠØ§Ù… -->
  <button id="toggleDaysButton" type="button" onclick="toggleDaysSummary()">Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù„Ø®Øµ Ø§Ù„Ø£ÙŠØ§Ù…</button>

  <div id="daysSummarySection" class="hidden">
    <h3>Ù…Ù„Ø®Øµ Ø§Ù„Ø£ÙŠØ§Ù… Ù„ÙØ±ÙŠÙ‚Ùƒ</h3>
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ù†Ø³Ø¨Ø© Ø§Ù„ÙŠÙˆÙ… (ØªØ¹Ø¨Ø¦Ø© + ØªØ·ÙˆØ¹ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ)</th>
          <th>ØªØ¨Ø±Ø¹Ø§Øª Ø§Ù„Ù…Ø¬Ø²Ø± (Ø§Ù„ÙŠÙˆÙ…)</th>
          <th>ØªØ¨Ø±Ø¹Ø§Øª Ø£ØµØ­Ø§Ø¨ Ø§Ù„Ø¨ÙŠØª (Ø§Ù„ÙŠÙˆÙ…)</th>
          <th>ØªÙ†ÙˆØ¹ (Ø§Ù„ÙŠÙˆÙ…)</th>
          <th>Ù…Ù†ØªØ¬Ø§Øª (Ø§Ù„ÙŠÙˆÙ…)</th>
        </tr>
      </thead>
      <tbody id="daysTableBody"></tbody>
    </table>
  </div>
  <button type="button" onclick="openLeaderboard()">ğŸ† Ø§ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</button>
  <button onclick="goBackToLogin()">Ø®Ø±ÙˆØ¬</button>
</div>

<!-- Admin Page -->
<div id="adminSection" class="container hidden">
  <h2>ØµÙØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
  <p class="hint">
    Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ØªØ¹Ø±Ø¶ Ù…Ù„Ø®Øµ ÙƒÙ„ Ø§Ù„ÙØ±Ù‚ ÙˆØªØ±ØªÙŠØ¨Ù‡Ù… Ø­Ø³Ø¨ Ø§Ù„Ù€ Score Ø§Ù„ÙƒÙ„ÙŠ (Ù…Ù† Ù¡Ù Ù )ØŒ ÙˆÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ©.
  </p>

  <button onclick="buildAdminTable()">ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ù‚</button>

  <h3>Ù…Ù„Ø®Øµ Ø§Ù„ÙØ±Ù‚</h3>
  <table>
    <thead>
      <tr>
        <th>Ø§Ù„ØªØ±ØªÙŠØ¨</th>
        <th>Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚</th>
        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th>
        <th>Ù…ØªÙˆØ³Ø· (ØªØ¹Ø¨Ø¦Ø© + ØªØ·ÙˆØ¹ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ) Ùª</th>
        <th>Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ùª</th>
        <th>Ø¯Ø±Ø¬Ø© Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ¹Ø¨Ø¦Ø© (0â€“10)</th>
        <th>Ø¯Ø±Ø¬Ø© Ø´ÙŠØª Ø§Ù„Ø­Ø¶ÙˆØ± (0â€“5)</th>
        <th>Score Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ Ùª (Ù…Ù† Ù¡Ù Ù )</th>
        <th>ØµÙˆØ± Ø§Ù„Ø¬ÙˆØ¯Ø©</th>
        <th>Ø±Ø§Ø¨Ø· Ø´ÙŠØª Ø§Ù„Ø­Ø¶ÙˆØ±</th>
      </tr>
    </thead>
    <tbody id="adminTableBody"></tbody>
  </table>

  <h3>Ø¹Ø±Ø¶ ØµÙˆØ± Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø®ØªØ§Ø±</h3>
  <div id="adminPhotosContainer" class="result"></div>

  <button onclick="goBackToLogin()">Ø®Ø±ÙˆØ¬</button>
</div>

<!-- Pop-up Ù„Ù„Ù€ New Score -->
<div id="scoreOverlay" class="score-overlay hidden">
  <div id="scoreOverlayContent" class="score-overlay-content"></div>
</div>

<!-- âœ… FIREBASE + APP LOGIC (Realtime Database) -->
<script type="module">
  // =========================
  // ğŸ”¥ Firebase Imports (CDN)
  // =========================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

  // =========================
  // âœ… 1) Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ù‡Ù†Ø§
  // =========================
const firebaseConfig = {
  apiKey: "AIzaSyDSxSRKH-cZFk9y4AqzrmFQftXcxI_ADSk",
  authDomain: "ramdan-92ed1.firebaseapp.com",
  databaseURL: "https://ramdan-92ed1-default-rtdb.firebaseio.com",
  projectId: "ramdan-92ed1",
  storageBucket: "ramdan-92ed1.firebasestorage.app",
  messagingSenderId: "467097580348",
  appId: "1:467097580348:web:52ebc0b97988857a60a439",
  measurementId: "G-YZSM40GPXF"
};

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // =========================
  // ===== CONSTANTS =====
  // =========================
  const ITEM_MAX_PERCENT = {
    fill_daily_target: 20,
    fill_quality: 10,
    fill_time: 10,
    donation_meat: 10,
    donation_house: 10,
    donation_variety: 5,
    products: 5,
    vol_team_presence: 15,
    vol_new_volunteers: 10,
    vol_sheet: 5
  };

  const MAX_NON_DONATION_PERCENT =
    ITEM_MAX_PERCENT.fill_daily_target +
    ITEM_MAX_PERCENT.fill_time +
    ITEM_MAX_PERCENT.vol_team_presence +
    ITEM_MAX_PERCENT.vol_new_volunteers; // 55

  const MANUAL_EXTRA_MAX =
    ITEM_MAX_PERCENT.fill_quality + ITEM_MAX_PERCENT.vol_sheet; // 15

  const MAX_DONATION_PERCENT =
    ITEM_MAX_PERCENT.donation_meat +
    ITEM_MAX_PERCENT.donation_house +
    ITEM_MAX_PERCENT.donation_variety +
    ITEM_MAX_PERCENT.products; // 30

  const MAX_TOTAL_PERCENT = MAX_NON_DONATION_PERCENT + MANUAL_EXTRA_MAX + MAX_DONATION_PERCENT; // 100

  const DONATION_TARGETS = {
    donation_meat: 15000,
    donation_house: 5000,
    donation_variety: 10,
    products: 3000
  };

  let currentTeamName = null;
  let currentTeamKey = null;
  const sessionMedia = {}; // ØµÙˆØ± Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙ‚Ø· (Ù…Ø´ Ø¨ØªØªØ®Ø²Ù† Ø¹Ù„Ù‰ firebase)

  function getMedal(rank) {
    if (rank === 1) return " ğŸ¥‡";
    if (rank === 2) return " ğŸ¥ˆ";
    if (rank === 3) return " ğŸ¥‰";
    return "";
  }
window.openLeaderboard = function () {
  window.location.href = "leaderboard.html";
};

  // =========================
  // âœ… Firebase "Storage layer"
  // =========================
  function teamKeyFromName(name) {
    // Firebase keys Ù…Ù…Ù†ÙˆØ¹ ÙÙŠÙ‡Ø§: . # $ [ ] /
    // encodeURIComponent Ù‡ÙŠØ´ÙŠÙ„ / ÙˆÙŠØ­ÙˆÙ‘Ù„ Ø§Ù„Ø±Ù…ÙˆØ² Ù„Ù…Ø³Ù…ÙˆØ­Ø©
    return encodeURIComponent(name.trim());
  }

  async function getTeamsStats() {
    const snap = await get(ref(db, "teamsStats"));
    return snap.exists() ? (snap.val() || {}) : {};
  }

  async function setTeamsStats(stats) {
    await set(ref(db, "teamsStats"), stats || {});
  }

  // =========================
  // ===== NAVIGATION / LOGIN =====
  // =========================
  function showSection(id) {
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('userSection').classList.add('hidden');
    document.getElementById('adminSection').classList.add('hidden');
    document.getElementById(id).classList.remove('hidden');
  }
  function openLeaderboard() {
  // Ù„Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¹Ù†Ø¯Ùƒ Ù…Ø®ØªÙ„Ù Ø¹Ø¯Ù„Ù‡ Ù‡Ù†Ø§
  window.location.href = "leaderboard.html";
}


  function setToday() {
    const todayInput = document.getElementById('dayDate');
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    todayInput.value = `${yyyy}-${mm}-${dd}`;
  }

  async function handleLogin() {
    const name = document.getElementById('loginName').value.trim();
    const pass = document.getElementById('loginPassword').value;

    if (!name) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
      return;
    }

    if (name === 'admin' && pass === 'admin123') {
      currentTeamName = null;
      currentTeamKey = null;
      showSection('adminSection');
      await buildAdminTable();
      return;
    }

    // Ù‚Ø§Ø¦Ø¯ ÙØ±ÙŠÙ‚
    currentTeamName = name;
    currentTeamKey = teamKeyFromName(currentTeamName);

    showSection('userSection');
    document.getElementById('teamName').value = currentTeamName;
    document.getElementById('userWelcome').textContent =
      `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ù‚Ø§Ø¦Ø¯ ÙØ±ÙŠÙ‚ "${currentTeamName}". Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠÙˆÙ… Ù„ÙØ±ÙŠÙ‚Ùƒ.`;

    setToday();
    document.getElementById('daysTableBody').innerHTML = '';
    document.getElementById('resultText').innerHTML = '';
    document.getElementById('daysSummarySection').classList.add('hidden');
    document.getElementById('toggleDaysButton').textContent = 'Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù„Ø®Øµ Ø§Ù„Ø£ÙŠØ§Ù…';

    const stats = await getTeamsStats();
    const t = stats[currentTeamKey];
    updateMoneyProgressBars(t || null);

    if (t && t.daysCount > 0) {
      const overallStats = computeTeamOverallStats(t);

      const scores = [];
      Object.keys(stats).forEach(k => {
        const ts = stats[k];
        if (ts && ts.daysCount > 0) {
          const s = computeTeamOverallStats(ts);
          scores.push({ key: k, name: ts.name || decodeURIComponent(k), score: s.overallCurrent });
        }
      });
      scores.sort((a, b) => b.score - a.score);
      const rank = scores.findIndex(x => x.key === currentTeamKey) + 1;
      const totalTeams = scores.length;

      document.getElementById('resultText').innerHTML =
        `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙØ±ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­. Score Ø§Ù„Ø­Ø§Ù„ÙŠ: ${overallStats.overallCurrent.toFixed(1)}Ùª â€“ Ø§Ù„Ù…Ø±ÙƒØ²: ${rank} Ù…Ù† ${totalTeams} ÙØ±ÙŠÙ‚${getMedal(rank)}.`;
    }
  }

  function goBackToLogin() {
    currentTeamName = null;
    currentTeamKey = null;
    showSection('loginSection');
  }

  function toggleDaysSummary() {
    const sec = document.getElementById('daysSummarySection');
    const btn = document.getElementById('toggleDaysButton');
    const isHidden = sec.classList.toggle('hidden');
    btn.textContent = isHidden ? 'Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù„Ø®Øµ Ø§Ù„Ø£ÙŠØ§Ù…' : 'Ø¥Ø®ÙØ§Ø¡ Ù…Ù„Ø®Øµ Ø§Ù„Ø£ÙŠØ§Ù…';
  }

  // =========================
  // ===== SCORING HELPERS =====
  // =========================
  function getNumber(id) {
    const el = document.getElementById(id);
    if (!el) return 0;
    return Number(el.value) || 0;
  }

  function scoreDailyBags() {
    const target = getNumber('bags_target');
    const done   = getNumber('bags_done');
    const maxPercent = ITEM_MAX_PERCENT.fill_daily_target;
    if (target <= 0) return 0;
    const ratio = Math.max(0, Math.min(done / target, 1));
    return ratio * maxPercent;
  }

  function calcPercentFromValue(value, maxPercent) {
    if (value >= 20) return maxPercent;
    if (value >= 15) return maxPercent - 2;
    if (value >= 10) return maxPercent - 4;
    if (value >= 5)  return maxPercent - 6;
    if (value > 0)   return maxPercent - 8;
    return 0;
  }

  function scoreItem(id) {
    const value = getNumber(id);
    const maxPercent = ITEM_MAX_PERCENT[id] || 0;
    return calcPercentFromValue(value, maxPercent);
  }

  function scoreVolTeamPresence() {
    const teamSize = getNumber('teamSize');
    const present = getNumber('vol_team_presence');
    const maxPercent = ITEM_MAX_PERCENT.vol_team_presence;

    if (teamSize <= 0) return 0;
    const ratio = Math.max(0, Math.min(present / teamSize, 1));
    return ratio * maxPercent;
  }

  function calcDonationPercent(totalAmount, target, maxPercent) {
    if (totalAmount <= 0) return 0;
    const ratio = totalAmount / target;
    const clamped = Math.min(ratio, 1);
    return clamped * maxPercent;
  }

  function computeTeamOverallStats(t) {
    if (!t || !t.daysCount || t.daysCount <= 0) {
      const manualQuality = t && t.manualQuality ? t.manualQuality : 0;
      const manualSheet = t && t.manualSheet ? t.manualSheet : 0;
      return {
        avgNonDonation: 0,
        donationTotalPercent: 0,
        manualQuality,
        manualSheet,
        overallCurrent: manualQuality + manualSheet
      };
    }

    const avgNonDonation = t.nonDonationTotalSum / t.daysCount;

    const donationMeatPercent = calcDonationPercent(
      t.donationMeatTotal || 0,
      DONATION_TARGETS.donation_meat,
      ITEM_MAX_PERCENT.donation_meat
    );
    const donationHousePercent = calcDonationPercent(
      t.donationHouseTotal || 0,
      DONATION_TARGETS.donation_house,
      ITEM_MAX_PERCENT.donation_house
    );
    const donationVarietyPercent = calcDonationPercent(
      t.donationVarietyTotal || 0,
      DONATION_TARGETS.donation_variety,
      ITEM_MAX_PERCENT.donation_variety
    );
    const productsPercent = calcDonationPercent(
      t.productsTotal || 0,
      DONATION_TARGETS.products,
      ITEM_MAX_PERCENT.products
    );

    const donationTotalPercent =
      donationMeatPercent + donationHousePercent + donationVarietyPercent + productsPercent;

    const manualQuality = t.manualQuality || 0;
    const manualSheet = t.manualSheet || 0;
    const overallCurrent = avgNonDonation + donationTotalPercent + manualQuality + manualSheet;

    return {
      avgNonDonation,
      donationTotalPercent,
      manualQuality,
      manualSheet,
      overallCurrent
    };
  }

  // =========================
  // ==== Progress bars ====
  // =========================
  function updateMoneyProgressBars(teamStats) {
    const meatTotal = teamStats && teamStats.donationMeatTotal ? teamStats.donationMeatTotal : 0;
    const houseTotal = teamStats && teamStats.donationHouseTotal ? teamStats.donationHouseTotal : 0;
    const productsTotal = teamStats && teamStats.productsTotal ? teamStats.productsTotal : 0;

    const meatPercent = Math.min(meatTotal / DONATION_TARGETS.donation_meat, 1) * 100;
    const housePercent = Math.min(houseTotal / DONATION_TARGETS.donation_house, 1) * 100;
    const productsPercent = Math.min(productsTotal / DONATION_TARGETS.products, 1) * 100;

    const meatFill = document.getElementById('meatProgressFill');
    const meatText = document.getElementById('meatProgressText');
    if (meatFill && meatText) {
      meatFill.style.width = meatPercent + '%';
      meatText.textContent =
        `${meatTotal} / ${DONATION_TARGETS.donation_meat} (${meatPercent.toFixed(1)}Ùª)`;
    }

    const houseFill = document.getElementById('houseProgressFill');
    const houseText = document.getElementById('houseProgressText');
    if (houseFill && houseText) {
      houseFill.style.width = housePercent + '%';
      houseText.textContent =
        `${houseTotal} / ${DONATION_TARGETS.donation_house} (${housePercent.toFixed(1)}Ùª)`;
    }

    const productsFill = document.getElementById('productsProgressFill');
    const productsText = document.getElementById('productsProgressText');
    if (productsFill && productsText) {
      productsFill.style.width = productsPercent + '%';
      productsText.textContent =
        `${productsTotal} / ${DONATION_TARGETS.products} (${productsPercent.toFixed(1)}Ùª)`;
    }
  }

  // =========================
  // ===== Pop-up Ù„Ù„Ù€ Score =====
  // =========================
  function showScoreOverlay(score, rank, totalTeams, diffScore, prevRank, newRank) {
    const overlay = document.getElementById('scoreOverlay');
    const box = document.getElementById('scoreOverlayContent');
    const medal = getMedal(rank);

    let trend;
    if (diffScore > 0.05) {
      trend = `â¬†ï¸ Ø²Ø§Ø¯ ${diffScore.toFixed(1)} Ù†Ù‚Ø·Ø© Ø¹Ù† Ø¢Ø®Ø± Ù…Ø±Ø©`;
    } else if (diffScore < -0.05) {
      trend = `â¬‡ï¸ Ù‚Ù„Ù‘ ${Math.abs(diffScore).toFixed(1)} Ù†Ù‚Ø·Ø© Ø¹Ù† Ø¢Ø®Ø± Ù…Ø±Ø©`;
    } else {
      trend = 'Ø§Ù„Ù€ Score Ø«Ø§Ø¨Øª ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ Ø²ÙŠ Ø¢Ø®Ø± Ù…Ø±Ø©';
    }

    let rankExtraText = '';
    let extraRocket = '';
    let extraClass = '';

    if (prevRank && prevRank > 0) {
      if (newRank < prevRank) {
        rankExtraText = `ğŸ”¥ Ø£Ø­Ù„Ù‰ Ù‚ÙØ²Ø©! Ø·Ù„Ø¹Øª Ù…Ù† Ø§Ù„Ù…Ø±ÙƒØ² ${prevRank} Ø¥Ù„Ù‰ ${newRank}.`;
        extraClass = 'rank-up';
      } else if (newRank > prevRank) {
        rankExtraText = `ğŸš€ Ù†Ø²Ù„Øª Ù…Ù† Ø§Ù„Ù…Ø±ÙƒØ² ${prevRank} Ø¥Ù„Ù‰ ${newRank}â€¦ Ø´Ø¯ Ø­ÙŠÙ„ÙƒÙ… Ø¨ÙƒØ±Ø© ğŸ’ª`;
        extraClass = 'rank-down';
        extraRocket = `<div class="rank-down-rocket">ğŸš€</div>`;
      }
    }

    const width = Math.min(score, MAX_TOTAL_PERCENT);

    box.classList.remove('rank-up', 'rank-down');
    if (extraClass) box.classList.add(extraClass);

    box.innerHTML = `
      ${extraRocket}
      <h2>âœ¨ Score Ø¬Ø¯ÙŠØ¯ Ù„ÙØ±ÙŠÙ‚Ùƒ âœ¨</h2>
      <p class="score-main">${score.toFixed(1)}Ùª Ù…Ù† ${MAX_TOTAL_PERCENT}Ùª</p>
      <div class="overlay-bar-wrapper">
        <div class="overlay-bar-fill" style="width:${width}%;"></div>
      </div>
      <p class="score-rank">ğŸ“Œ Ù…Ø±ÙƒØ²Ùƒ Ø§Ù„Ø¢Ù†: <strong>${newRank}${medal}</strong> Ù…Ù† ${totalTeams} ÙØ±ÙŠÙ‚</p>
      ${rankExtraText ? `<p class="score-rank">${rankExtraText}</p>` : ''}
      <p class="score-trend">${trend}</p>
      <button onclick="hideScoreOverlay()">ØªÙ…Ø§Ù… Ø´ÙƒØ±Ø§Ù‹ âœ¨</button>
    `;

    overlay.classList.remove('hidden');
  }

  function hideScoreOverlay() {
    document.getElementById('scoreOverlay').classList.add('hidden');
  }

  // =========================
  // ===== USER: CALCULATE DAY (Ù…Ø¹ daysDates) =====
  // =========================
  async function calculateDay() {
    if (!currentTeamName || !currentTeamKey) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ ÙƒÙ‚Ø§Ø¦Ø¯ ÙØ±ÙŠÙ‚ Ø£ÙˆÙ„Ø§Ù‹');
      return;
    }

    // Ù„Ø§Ø²Ù… ØªØ§Ø±ÙŠØ®
    const dayDate = document.getElementById('dayDate').value;
    if (!dayDate) {
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ù‚Ø¨Ù„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·');
      return;
    }

    const donationMeatToday = getNumber('donation_meat');
    const donationHouseToday = getNumber('donation_house');
    const donationVarietyToday = getNumber('donation_variety');
    const productsToday = getNumber('products_today');
    const sheetLink = document.getElementById('vol_sheet_link').value.trim();

    // ØµÙˆØ± Ø§Ù„Ø¬Ù„Ø³Ø© (Ù…Ø´ Ø¨ØªØªØ®Ø²Ù† Ø¹Ù„Ù‰ firebase)
    const photosInput = document.getElementById('fill_quality_photos');
    const photos = photosInput && photosInput.files ? Array.from(photosInput.files) : [];
    sessionMedia[currentTeamKey] = sessionMedia[currentTeamKey] || {};
    sessionMedia[currentTeamKey].photos = photos.map(file => URL.createObjectURL(file));

    const allStats = await getTeamsStats();

    let teamStats = allStats[currentTeamKey] || {
      name: currentTeamName,
      daysCount: 0,
      nonDonationTotalSum: 0,
      donationMeatTotal: 0,
      donationHouseTotal: 0,
      donationVarietyTotal: 0,
      productsTotal: 0,
      manualQuality: 0,
      manualSheet: 0,
      lastSheetLink: '',
      daysDates: []
    };

    // Ø¯Ø§ØªØ§ Ù‚Ø¯ÙŠÙ…Ø©ØŸ
    if (!teamStats.name) teamStats.name = currentTeamName;
    if (!Array.isArray(teamStats.daysDates)) teamStats.daysDates = [];

    // Anti-cheat: Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (teamStats.daysDates.includes(dayDate)) {
      alert('Ø§Ù„ÙŠÙˆÙ… Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø³Ø¬Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØ±ÙŠÙ‚. Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ù…Ø®ØªÙ„Ù.');
      return;
    }

    const prevStats = computeTeamOverallStats(teamStats);
    const prevScore = prevStats.overallCurrent;

    // ØªØ±ØªÙŠØ¨ Ù‚Ø¨Ù„
    let prevRank = 0;
    {
      const scoresPre = [];
      Object.keys(allStats).forEach(key => {
        const ts = allStats[key];
        if (ts && ts.daysCount > 0) {
          const s = computeTeamOverallStats(ts);
          scoresPre.push({ key, score: s.overallCurrent });
        }
      });
      scoresPre.sort((a, b) => b.score - a.score);
      const idx = scoresPre.findIndex(x => x.key === currentTeamKey);
      prevRank = idx >= 0 ? idx + 1 : 0;
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ±Ø§ÙƒÙ…Ø§Øª
    teamStats.donationMeatTotal += donationMeatToday;
    teamStats.donationHouseTotal += donationHouseToday;
    teamStats.donationVarietyTotal += donationVarietyToday;
    teamStats.productsTotal += productsToday;

    if (sheetLink) teamStats.lastSheetLink = sheetLink;

    // Ø­Ø³Ø§Ø¨ non-donation Ø§Ù„ÙŠÙˆÙ…
    const dailyBagsPercent = scoreDailyBags();
    const nonDonationToday =
      dailyBagsPercent +
      scoreItem('fill_time') +
      scoreVolTeamPresence() +
      scoreItem('vol_new_volunteers');

    teamStats.daysCount += 1;
    teamStats.nonDonationTotalSum += nonDonationToday;

    // Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®
    teamStats.daysDates.push(dayDate);

    // Ø­ÙØ¸ Ø¹Ù„Ù‰ Firebase
    allStats[currentTeamKey] = teamStats;
    await setTeamsStats(allStats);

    updateMoneyProgressBars(teamStats);

    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ score ÙˆØªØ±ØªÙŠØ¨
    const overallStats = computeTeamOverallStats(teamStats);
    const overallCurrent = overallStats.overallCurrent;

    const scores = [];
    Object.keys(allStats).forEach(key => {
      const ts = allStats[key];
      if (ts && ts.daysCount > 0) {
        const s = computeTeamOverallStats(ts);
        scores.push({ key, name: ts.name || decodeURIComponent(key), score: s.overallCurrent });
      }
    });
    scores.sort((a, b) => b.score - a.score);

    const rank = scores.findIndex(x => x.key === currentTeamKey) + 1;
    const totalTeams = scores.length;

    document.getElementById('resultText').innerHTML =
      `ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙŠÙˆÙ… ${dayDate} Ø¨Ù†Ø¬Ø§Ø­ âœ…<br>` +
      `Score Ø§Ù„Ø­Ø§Ù„ÙŠ: ${overallCurrent.toFixed(1)}Ùª â€“ Ø§Ù„Ù…Ø±ÙƒØ²: ${rank} Ù…Ù† ${totalTeams} ÙØ±ÙŠÙ‚${getMedal(rank)}.`;

    // Ø¬Ø¯ÙˆÙ„ Ù…Ù„Ø®Øµ Ø§Ù„Ø£ÙŠØ§Ù… (Ø¬Ù„Ø³Ø© UI ÙÙ‚Ø·)
    const tbody = document.getElementById('daysTableBody');
    const row = document.createElement('tr');

    const dateCell = document.createElement('td');
    dateCell.textContent = dayDate;

    const nonDonationCell = document.createElement('td');
    nonDonationCell.textContent = nonDonationToday.toFixed(1);

    const meatCell = document.createElement('td');
    meatCell.textContent = donationMeatToday;

    const houseCell = document.createElement('td');
    houseCell.textContent = donationHouseToday;

    const varietyCell = document.createElement('td');
    varietyCell.textContent = donationVarietyToday;

    const productsCell = document.createElement('td');
    productsCell.textContent = productsToday;

    row.appendChild(dateCell);
    row.appendChild(nonDonationCell);
    row.appendChild(meatCell);
    row.appendChild(houseCell);
    row.appendChild(varietyCell);
    row.appendChild(productsCell);
    tbody.appendChild(row);

    const diff = overallCurrent - prevScore;
    showScoreOverlay(overallCurrent, rank, totalTeams, diff, prevRank, rank);
  }

  // =========================
  // ===== ADMIN =====
  // =========================
  async function updateManualScore(teamKey, field, value) {
    const stats = await getTeamsStats();
    if (!stats[teamKey]) return;

    let v = Number(value) || 0;

    if (field === 'manualQuality') {
      if (v < 0) v = 0;
      if (v > ITEM_MAX_PERCENT.fill_quality) v = ITEM_MAX_PERCENT.fill_quality;
      stats[teamKey].manualQuality = v;
    } else if (field === 'manualSheet') {
      if (v < 0) v = 0;
      if (v > ITEM_MAX_PERCENT.vol_sheet) v = ITEM_MAX_PERCENT.vol_sheet;
      stats[teamKey].manualSheet = v;
    }

    await setTeamsStats(stats);
    await buildAdminTable();
  }

  function showTeamPhotos(teamKey) {
    const container = document.getElementById('adminPhotosContainer');
    container.innerHTML = '';
    const media = sessionMedia[teamKey];
    if (!media || !media.photos || media.photos.length === 0) {
      container.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…Ø±ÙÙˆØ¹Ø© Ù„Ù„Ø¬ÙˆØ¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØ±ÙŠÙ‚ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©.';
      return;
    }
    media.photos.forEach(url => {
      const img = document.createElement('img');
      img.src = url;
      container.appendChild(img);
    });
  }

  async function buildAdminTable() {
    const stats = await getTeamsStats();
    const tbody = document.getElementById('adminTableBody');
    tbody.innerHTML = '';

    const keys = Object.keys(stats || {});
    if (keys.length === 0) {
      const row = document.createElement('tr');
      const cell = document.createElement('td');
      cell.colSpan = 10;
      cell.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ±Ù‚ Ù…Ø³Ø¬Ù‘Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.';
      row.appendChild(cell);
      tbody.appendChild(row);
      return;
    }

    const rowsData = [];
    keys.forEach(key => {
      const t = stats[key];
      if (!t || !t.daysCount || t.daysCount <= 0) return;
      const overallStats = computeTeamOverallStats(t);
      rowsData.push({ teamKey: key, teamName: t.name || decodeURIComponent(key), t, overallStats });
    });

    if (rowsData.length === 0) {
      const row = document.createElement('tr');
      const cell = document.createElement('td');
      cell.colSpan = 10;
      cell.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ±Ù‚ Ù…Ø³Ø¬Ù‘Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.';
      row.appendChild(cell);
      tbody.appendChild(row);
      return;
    }

    rowsData.sort((a, b) => b.overallStats.overallCurrent - a.overallStats.overallCurrent);

    rowsData.forEach((item, index) => {
      const teamKey = item.teamKey;
      const teamName = item.teamName;
      const t = item.t;
      const s = item.overallStats;
      const rank = index + 1;

      const row = document.createElement('tr');

      const rankCell = document.createElement('td');
      rankCell.textContent = `${rank}${getMedal(rank)}`;

      const nameCell = document.createElement('td');
      nameCell.textContent = teamName;

      const daysCell = document.createElement('td');
      daysCell.textContent = t.daysCount;

      const avgNonDonationCell = document.createElement('td');
      avgNonDonationCell.textContent = s.avgNonDonation.toFixed(1);

      const donationCell = document.createElement('td');
      donationCell.textContent = s.donationTotalPercent.toFixed(1);

      const qualityCell = document.createElement('td');
      const qInput = document.createElement('input');
      qInput.type = 'number';
      qInput.min = '0';
      qInput.max = String(ITEM_MAX_PERCENT.fill_quality);
      qInput.value = (s.manualQuality || 0).toFixed(1).replace(/\.0$/, '');
      qInput.style.width = '60px';
      qInput.onchange = (e) => updateManualScore(teamKey, 'manualQuality', e.target.value);
      qualityCell.appendChild(qInput);

      const sheetCellScore = document.createElement('td');
      const sInput = document.createElement('input');
      sInput.type = 'number';
      sInput.min = '0';
      sInput.max = String(ITEM_MAX_PERCENT.vol_sheet);
      sInput.value = (s.manualSheet || 0).toFixed(1).replace(/\.0$/, '');
      sInput.style.width = '60px';
      sInput.onchange = (e) => updateManualScore(teamKey, 'manualSheet', e.target.value);
      sheetCellScore.appendChild(sInput);

      const overallCell = document.createElement('td');
      overallCell.textContent = s.overallCurrent.toFixed(1);

      const photosCell = document.createElement('td');
      const media = sessionMedia[teamKey];
      if (media && media.photos && media.photos.length > 0) {
        const btn = document.createElement('button');
        btn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±';
        btn.onclick = () => showTeamPhotos(teamKey);
        photosCell.appendChild(btn);
      } else {
        photosCell.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ (Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©)';
      }

      const sheetLinkCell = document.createElement('td');
      if (t.lastSheetLink) {
        const a = document.createElement('a');
        a.href = t.lastSheetLink;
        a.target = '_blank';
        a.textContent = 'ÙØªØ­ Ø§Ù„Ø´ÙŠØª';
        sheetLinkCell.appendChild(a);
      } else {
        sheetLinkCell.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
      }

      row.appendChild(rankCell);
      row.appendChild(nameCell);
      row.appendChild(daysCell);
      row.appendChild(avgNonDonationCell);
      row.appendChild(donationCell);
      row.appendChild(qualityCell);
      row.appendChild(sheetCellScore);
      row.appendChild(overallCell);
      row.appendChild(photosCell);
      row.appendChild(sheetLinkCell);

      tbody.appendChild(row);
    });
  }

  // =========================
  // âœ… expose functions for onclick=""
  // =========================
  window.handleLogin = handleLogin;
  window.goBackToLogin = goBackToLogin;
  window.toggleDaysSummary = toggleDaysSummary;
  window.calculateDay = calculateDay;
  window.buildAdminTable = buildAdminTable;
  window.hideScoreOverlay = hideScoreOverlay;
  window.updateManualScore = updateManualScore;
  window.showTeamPhotos = showTeamPhotos;
</script>

</body>
</html>
